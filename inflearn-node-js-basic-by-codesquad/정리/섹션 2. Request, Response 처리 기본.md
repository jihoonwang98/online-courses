# [Node.js 웹개발로 알아보는 백엔드 자바스크립트의 이해] 섹션 2. Request, Response 처리 기본

> [인프런](https://www.inflearn.com/course/node-js-%EC%9B%B9%EA%B0%9C%EB%B0%9C)
>
> [실습 코드 - 깃허브](https://github.com/crongro/node_server_inflearn)



### 목차

- POST 요청 처리
- View engine을 활용한 응답 처리
- JSON을 활용한 Ajax 처리



## \#1 POST 요청 처리

- 이번에는 html `form` 태그를 이용해서 POST 요청을 보내보고 서버에서 처리해보자.

- `form.html`

  ```html
  <!doctype html>
  <html>
    <head>
      <meta charset="utf-8">
      <title>email form</title>
    </head>
    <body>
      <form action="/email_post" method="post">
        email: <input type="text" name="email"><br/>
        submit <input type="submit">
      </form>
    </body>
  </html>
  ```

  - `public` 폴더에 저장

- `app.js`

  ```javascript
  var express = require('express');
  var app = express();
  app.listen(3000, function() {
  	console.log('start! express server on port 3000');
  });
  
  app.use(express.static('public'));
  
  app.get('/', function(req, res) {
    res.sendFile(__dirname + '/public/main.html');
  });
  
  
  <!-- 밑 부분 추가 -->
  app.post('/email_post', function(req, res) {
    res.send('post response')
  });
  ```

  - `localhost:3000/form.html`으로 접속해서 `제출` 버튼 누르면 

    POST `localhost:3000/email_post` 요청이 날라가고, `post response`라고 응답이 옴.

  - 데이터는 어떻게 받는가?

    - GET 요청은 `req.param('email')` 이런식으로 받을 수 있는데,
    - POST 요청의 경우는 `body-parser`라는 별도의 모듈이 필요하다.

- `body-parser`

  - 설치 

    - `npm install body-parser --save`로 프로젝트에 설치해주자.

  - import

    - `express`처럼 `require`를 이용해 불러오자..

      -  `var bodyParser = require('body-parser');`

    - `express`한테도 '나 `body-parser` 쓸거야'라고 알려준다.

      - ```javascript
        app.use(bodyParser.json());  
        app.use(bodyParser.urlencoded({extended:true}));
        ```

  - 예제

    ```javascript
    var express = require('express');
    var app = express();
    var bodyParser = require('body-parser');
    app.listen(3000, function() {
    	console.log('start! express server on port 3000');
    });
    
    app.use(express.static('public'));
    app.use(bodyParser.json());
    app.use(bodyParser.urlencoded({extended:true}));
    
    app.get('/', function(req, res) {
      // req.param('email')   ->  email이라는 이름의 parameter value
      res.sendFile(__dirname + '/public/main.html');
    });
    
    app.post('/email_post', function(req, res) {
      console.log(req.body); // { email: 'jihoonwang98@naver.com' }     
      console.log(req.body.email); // jihoonwang98@naver.com
      res.send('<h1>welcome!! ' + req.body.email + '</h1>');
    });
    ```



## \#2 View engine을 활용한 응답 처리

- `ejs`라는 뷰 템플릿을 이용해서 express에서 html 응답을 줄 때, data와 html을 어떻게 결합해서 줄까?를 알아보자.

- `ejs` 설치

  - `npm install ejs --save`

  - 프로젝트 루트 폴더에 `views` 폴더를 새로 만들고 그 안에 `email.ejs` 파일을 새로 만든다.

    - `email.ejs`

      ```ejs
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>email template</title>
        </head>
        <body>
          <form>
            <h1>Welcome!! <%= email %> </h1>
          </form>
        </body>
      </html>
      ```

  - `app.js` 

    ```javascript
    var express = require('express');
    var app = express();
    var bodyParser = require('body-parser');
    app.listen(3000, function() {
    	console.log('start! express server on port 3000');
    });
    
    app.use(express.static('public'));
    app.use(bodyParser.json());
    app.use(bodyParser.urlencoded({extended:true}));
    app.set('view engine', 'ejs');  // 'view engine은 ejs야'라고 말해줌
    
    
    // url routing
    ...
    
    app.post('/email_post', function(req, res) {
      console.log(req.body.email);
      res.render('email.ejs', {'email': req.body.email});
    });
    ```

- `ejs` 외에도 `pug`, `Jade` 같은 view template engine들이 있다.

  - 예제

    `app.set('view engine', 'pug'); ` -> pug 쓰겠다.

- 프로젝트 root 폴더에 위치한 `node_modules` 폴더에 `ejs`, `express`와 같은 모듈들이 존재하게 된다.
  - 이때, github에 코드를 올릴 때는 `node_modules` 폴더가 용량이 크기 때문에 올리지 않는다.
  - 대신 코드를 내려받은 사람은 `package.json`에 저장된 의존성 정보들을 바탕으로 `npm install` 명령어를 사용하면 프로젝트 내 사용된 모든 모듈들을 받을 수 있다.



## \#3 JSON을 활용한 Ajax 처리

- 이번엔 JSON 파일 형식을 Ajax를 이용해 서버에 보내보자.

- `form.html`

  ```javascript
  <!doctype html>
  <html>
    <head>
      <meta charset="utf-8">
      <title>email form</title>
    </head>
    <body>
      <form action="/email_post" method="post">
        email: <input type="text" name="email"><br/>
        submit <input type="submit">
      </form>
  
      <button class="ajaxsend">ajaxsend</button>
      <div class="result"></div>
      <script>
        document.querySelector('.ajaxsend').addEventListener('click', function() {
          var inputData = document.forms[0].elements[0].value;
          sendAjax('http://localhost:3000/ajax_send_mail', inputData);
        });
  
        function sendAjax(url, data) {
          var data = {'email': data};
          data = JSON.stringify(data);
  
          var xhr = new XMLHttpRequest();
          xhr.open('POST', url);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(data);
  
          xhr.addEventListener('load', function() {
            console.log(xhr.responseText);
            var result = JSON.parse(xhr.responseText);
            document.querySelector('.result').innerHTML = result.email;
          });
        }
      </script>
    </body>
  </html>
  ```

  - `data = JSON.stringify(data);` 
    - 통신할 때는 문자열로만 주고받을 수 있어서 stringify 해주자.

- `app.js`

  ```javascript
  var express = require('express');
  var app = express();
  var bodyParser = require('body-parser');
  app.listen(3000, function() {
  	console.log('start! express server on port 3000');
  });
  
  app.use(express.static('public'));
  app.use(bodyParser.json());
  app.use(bodyParser.urlencoded({extended:true}));
  app.set('view engine', 'ejs');  // 'view engine은 ejs야'라고 말해줌
  
  
  // url routing
  app.get('/', function(req, res) {
    // req.param('email')   ->  email이라는 이름의 parameter value
    res.sendFile(__dirname + '/public/main.html');
  });
  
  app.post('/email_post', function(req, res) {
    console.log(req.body.email);
    res.render('email.ejs', {'email': req.body.email});
  });
  
  app.post('/ajax_send_mail', function(req, res) {
    console.log(req.body.email);
    var responseData = {'result': 'ok', 'email': req.body.email};
    res.json(responseData);
  });
  ```

